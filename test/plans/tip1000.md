# Testing Plan for PR #2116 (TIP-1000 Implementation)

## Summary of Changes

This PR implements TIP-1000 which introduces significant gas pricing changes and the T1 hardfork for the Tempo protocol.

### Files Changed

| File | Changes |
|------|---------|
| `crates/chainspec/src/hardfork.rs` | Added T1 hardfork, `is_t1()` method, updated `is_t0()` |
| `crates/evm/src/error.rs` | Added `Clone` derive to `TempoEvmError` |
| `crates/evm/src/evm.rs` | Gas params override, 30M gas cap |
| `crates/precompiles/src/storage/evm.rs` | Added `new_with_gas_limit()` constructor |
| `crates/revm/src/evm.rs` | Added `additional_initial_gas` and `initial_gas` fields |
| `crates/revm/src/gas_params.rs` | **NEW FILE** - T1 gas cost overrides |
| `crates/revm/src/handler.rs` | Major refactoring of gas calculation, OOG handling |
| `crates/transaction-pool/src/validator.rs` | Uses T1 gas params |

### T1 Gas Cost Overrides

| Gas Type | T0 (approx) | T1 | Multiplier |
|----------|-------------|-----|------------|
| SSTORE set (without load) | ~20,000 | 250,000 | 12.5x |
| TX create cost | ~53,000 | 250,000 | 4.7x |
| CREATE/CREATE2 opcodes | ~32,000 | 500,000 | 15.6x |
| New account cost | ~25,000 | 250,000 | 10x |
| Selfdestruct new account | ~25,000 | 250,000 | 10x |
| Code deposit cost | ~200/byte | 1,000/byte | 5x |
| EIP-7702 per empty account | ~25,000 | 12,500 | 0.5x (reduced!) |
| Auth account creation (ID 255) | 0 | 250,000 | NEW |

---

## Critical Security-Sensitive Changes

### 1. Key Authorization OOG Handling (HIGH RISK)

**Location:** `handler.rs:788-798`

```rust
match keychain.authorize_key(*root_account, authorize_call) {
    Ok(_) => Ok(true),
    Err(TempoPrecompileError::OutOfGas) => Ok(true),  // Returns OK on OOG!
    Err(TempoPrecompileError::Fatal(err)) => Err(EVMError::Custom(err)),
    Err(err) => Err(TempoInvalidTransaction::KeychainPrecompileError { ... }.into()),
}
```

**Security Concern:** On OOG, the function returns `Ok(true)` but key authorization may be partially completed. Need to verify:
- State is properly rolled back on OOG
- No partial key authorization can be exploited
- `additional_initial_gas = u64::MAX` properly triggers OOG frame result downstream

### 2. EIP-7702 Refund Removal (ECONOMIC CHANGE)

**Location:** `handler.rs:559-565`

```rust
// TIP-1000: State Creation Cost Increase
// Authorization lists: There is no refund if the account already exists
if spec.is_t1() {
    return Ok(0);  // Always returns 0 refund on T1
}
```

**Impact:** Users authorizing existing accounts won't get gas refunds on T1. This changes wallet gas estimation.

### 3. Magic Number for Gas ID

**Location:** `gas_params.rs`

```rust
(GasId::new(255), 250_000),  // Auth account creation cost
```

**Concern:** `GasId(255)` is undocumented and could collide with future revm gas IDs.

---

## Existing Tests in `handler.rs`

| # | Test Name | Status |
|---|-----------|--------|
| 1 | `test_get_token_balance` | Pass as-is |
| 2 | `test_get_fee_token` | Pass as-is |
| 3 | `test_aa_gas_single_call_vs_normal_tx` | Updated (gas_params param) |
| 4 | `test_aa_gas_multiple_calls_overhead` | Updated (gas_params param) |
| 5 | `test_aa_gas_p256_signature` | Updated (gas_params param) |
| 6 | `test_aa_gas_create_call` | Updated (gas_params param) |
| 7 | `test_aa_gas_value_transfer` | Updated (gas_params param) |
| 8 | `test_aa_gas_access_list` | Updated (gas_params param) |
| 9 | `test_key_authorization_rlp_encoding` | Pass as-is |
| 10 | `test_aa_gas_floor_gas_prague` | Updated (gas_params param) |
| 11 | `test_zero_value_transfer` | Pass as-is |
| 12 | `test_key_authorization_gas_with_limits` | Pass as-is |
| 13 | `test_key_authorization_gas_in_batch` | Updated (gas_params param) |
| 14 | `test_2d_nonce_gas_in_intrinsic_gas` | **NEEDS REWORK** |
| 15 | `test_multicall_gas_refund_accounting` | Pass as-is |

---

## Tests That Need Modification

### 1. `test_2d_nonce_gas_in_intrinsic_gas` - MUST REWORK

**Problem:** The PR removed 2D nonce gas calculation from `validate_aa_initial_tx_gas`. The test expects:
```rust
assert_eq!(gas.initial_gas, BASE_INTRINSIC_GAS + NEW_NONCE_KEY_GAS);
```

But this gas is now added via `additional_initial_gas` during `validate_against_state_and_deduct_caller`, not in initial gas validation.

**Action:** Replace with two tests:
1. Verify `validate_initial_tx_gas` does NOT include 2D nonce gas
2. Verify `additional_initial_gas` is set correctly during state validation

### 2. Existing Tests Only Use Default GasParams

**Problem:** All tests use `GasParams::default()` which has T0 costs. Need parallel tests with T1 params.

**Action:** Add T1 variants of gas calculation tests.

---

## New Tests to Add

### Priority 1: Security Critical (Must Have)

#### 1.1 OOG Frame Result Tests (TODO in code)

**Location:** `handler.rs:487-488` has explicit TODO:
```rust
// TODO(rakita) need a test for this!
// check both execution and inspect_execution
```

| Test | Description |
|------|-------------|
| `test_execution_oog_gas_limit_exactly_at_boundary` | `gas_limit == adjusted_gas.initial_gas` |
| `test_execution_oog_gas_limit_one_below` | `gas_limit == adjusted_gas.initial_gas - 1` |
| `test_execution_oog_gas_limit_one_above` | `gas_limit == adjusted_gas.initial_gas + 1` |
| `test_execution_oog_returns_call_frame_result` | Verify `FrameResult::Call` for CALL tx |
| `test_execution_oog_returns_create_frame_result` | Verify `FrameResult::Create` for CREATE tx |
| `test_inspect_execution_oog_same_behavior` | Inspector path matches non-inspector |
| `test_additional_initial_gas_max_triggers_oog` | `additional_initial_gas = u64::MAX` causes OOG |

#### 1.2 Key Authorization State Consistency

| Test | Description |
|------|-------------|
| `test_key_auth_oog_no_partial_state` | Verify state is clean after OOG in key auth |
| `test_key_auth_oog_rollback_verification` | Explicitly check journal rollback on OOG |
| `test_key_auth_success_state_persists` | Verify key auth state persists on success |
| `test_key_auth_fatal_error_propagation` | `TempoPrecompileError::Fatal` bubbles up |
| `test_key_auth_non_fatal_error_types` | Test each non-fatal error type |

#### 1.3 Hardfork Transition Security

| Test | Description |
|------|-------------|
| `test_t0_transaction_no_tip1000_costs` | T0 spec doesn't charge TIP-1000 costs |
| `test_t1_transaction_has_tip1000_costs` | T1 spec charges TIP-1000 costs |
| `test_hardfork_boundary_exact_timestamp` | Transaction at exact T1 activation time |
| `test_gas_params_isolation_t0_vs_t1` | Gas params don't leak between hardforks |

### Priority 2: Core Functionality

#### 2.1 T1 Gas Parameters (`gas_params.rs`)

| Test | Description |
|------|-------------|
| `test_tempo_gas_params_t0_returns_defaults` | T0 has no Tempo-specific overrides |
| `test_tempo_gas_params_t1_sstore_set_cost` | Verify 250,000 |
| `test_tempo_gas_params_t1_tx_create_cost` | Verify 250,000 |
| `test_tempo_gas_params_t1_create_opcode_cost` | Verify 500,000 |
| `test_tempo_gas_params_t1_new_account_cost` | Verify 250,000 |
| `test_tempo_gas_params_t1_code_deposit_cost` | Verify 1,000 per byte |
| `test_tempo_gas_params_t1_eip7702_per_empty` | Verify 12,500 |
| `test_tempo_gas_params_t1_auth_creation_cost` | Verify 250,000 via custom GasId |
| `test_gas_id_255_no_collision` | Verify GasId(255) doesn't conflict |

#### 2.2 Initial Gas with TIP-1000 Costs

| Test | Description |
|------|-------------|
| `test_initial_gas_tx_nonce_zero_t1_adds_cost` | `nonce == 0` on T1 adds 250k |
| `test_initial_gas_tx_nonce_nonzero_t1_no_cost` | `nonce > 0` on T1 no extra cost |
| `test_initial_gas_tx_nonce_zero_t0_no_cost` | `nonce == 0` on T0 no extra cost |
| `test_initial_gas_auth_nonce_zero_adds_cost` | Auth with `nonce == 0` adds 250k (T1) |
| `test_initial_gas_auth_nonce_nonzero_no_cost` | Auth with `nonce > 0` no extra cost |
| `test_initial_gas_multiple_auth_nonce_zero` | Multiple auths all with nonce=0 |
| `test_initial_gas_mixed_auth_nonces` | Mix of nonce=0 and nonce>0 auths |

#### 2.3 EIP-7702 No-Refund Behavior

| Test | Description |
|------|-------------|
| `test_eip7702_t0_returns_refund` | T0 returns proper refund for existing accounts |
| `test_eip7702_t1_returns_zero_existing_account` | T1 returns 0 even for existing account |
| `test_eip7702_t1_returns_zero_new_account` | T1 returns 0 for new account |
| `test_eip7702_gas_comparison_t0_vs_t1` | Compare total gas for same auth list |

### Priority 3: Key Authorization Gas Limiting

| Test | Description |
|------|-------------|
| `test_key_auth_gas_limit_calculation` | `tx.gas_limit - initial_gas` is correct |
| `test_key_auth_provider_gas_tracking` | `provider.gas_used()` returns accurate value |
| `test_key_auth_additional_gas_set_on_success` | `additional_initial_gas = provider.gas_used()` |
| `test_key_auth_additional_gas_max_on_oog` | `additional_initial_gas = u64::MAX` on OOG |
| `test_key_auth_zero_gas_spending_resets` | Zero spending resets `additional_initial_gas` to 0 |

### Priority 4: Hardfork Methods (`hardfork.rs`)

| Test | Description |
|------|-------------|
| `test_t1_greater_than_t0` | `T1 > T0` ordering |
| `test_is_t0_true_for_t0` | `T0.is_t0() == true` |
| `test_is_t0_true_for_t1` | `T1.is_t0() == true` (>= comparison) |
| `test_is_t1_false_for_t0` | `T0.is_t1() == false` |
| `test_is_t1_true_for_t1` | `T1.is_t1() == true` |
| `test_tempo_hardfork_at_returns_t1` | `tempo_hardfork_at()` handles T1 timestamp |

### Priority 5: EVM Configuration (`evm.rs`)

| Test | Description |
|------|-------------|
| `test_tempo_evm_applies_gas_params` | `cfg_env.gas_params` set via `tempo_gas_params()` |
| `test_tempo_evm_30m_gas_cap` | `tx_gas_limit_cap == 30_000_000` |
| `test_tempo_evm_gas_limit_at_cap` | TX with exactly 30M gas accepted |
| `test_tempo_evm_gas_limit_over_cap` | TX with >30M gas rejected |

### Priority 6: Transaction Pool Consistency

| Test | Description |
|------|-------------|
| `test_pool_validator_gas_matches_execution` | Pool and execution use same gas params |
| `test_pool_accepts_execution_accepts` | TX accepted in pool executes successfully |
| `test_pool_rejects_insufficient_gas` | Pool rejects TX with insufficient gas |

---

## Regression Tests

### Gas Calculation Consistency

| Test | Description |
|------|-------------|
| `test_aa_gas_with_t1_params_single_call` | Existing test with T1 gas params |
| `test_aa_gas_with_t1_params_multiple_calls` | Multi-call with T1 gas params |
| `test_aa_gas_with_t1_params_create` | CREATE with T1 gas params |
| `test_floor_gas_still_validated_for_aa` | Floor gas check not removed for AA |

### 2D Nonce Gas (Reworked)

| Test | Description |
|------|-------------|
| `test_2d_nonce_not_in_initial_gas` | `validate_initial_tx_gas` excludes 2D nonce |
| `test_2d_nonce_in_additional_initial_gas` | Gas added via `additional_initial_gas` |
| `test_2d_nonce_new_key_gas_cost` | New key costs `COLD_SLOAD + SSTORE_SET` |
| `test_2d_nonce_existing_key_gas_cost` | Existing key costs `COLD_SLOAD + WARM_SSTORE_RESET` |

---

## Integration/E2E Tests

| Scenario | Description |
|----------|-------------|
| Contract deployment T0 vs T1 | Same contract, verify gas difference |
| Large contract deployment T1 | Verify new code deposit cost (1000/byte) |
| CREATE2 opcode T1 | Verify 500,000 gas cost |
| SSTORE new slot T1 | Verify 250,000 gas cost |
| EIP-7702 auth flow T1 | Full authorization with gas verification |
| AA TX with key auth + OOG | Key auth runs OOG, TX still valid |
| Hardfork transition | TX submitted T0, executed T1 |
| Gas limit at 30M | Max gas limit transaction |

---

## Edge Cases

| Test | Description |
|------|-------------|
| `test_gas_limit_exactly_intrinsic` | `gas_limit == intrinsic_gas` |
| `test_gas_limit_one_below_intrinsic` | `gas_limit == intrinsic_gas - 1` |
| `test_empty_aa_batch` | AA TX with no calls |
| `test_max_initcode_size_t1` | CREATE with max initcode, verify cost |
| `test_auth_list_all_nonce_zero` | All auths have nonce=0 |
| `test_auth_list_all_keychain_filtered` | All auths filtered (keychain sigs) |
| `test_nonce_u64_max_vs_zero` | Edge case nonce values |

---

## Code Quality Issues to Address

| Issue | Location | Description |
|-------|----------|-------------|
| Typo | `handler.rs:560` | "existss" should be "exists" |
| Magic number | `gas_params.rs` | `GasId::new(255)` needs named constant |
| TODO | `handler.rs:487` | OOG test needed |
| TODO | `handler.rs:1111` | Check if needed for AA gas |
| TODO | `validator.rs:292` | Hardforked check missing |

---

## Summary

| Category | Count |
|----------|-------|
| Existing tests that pass as-is | 9 |
| Existing tests already updated | 6 |
| Tests needing logic rework | 1 |
| **New tests to add** | **~55-60** |
| Security-critical tests | ~15 |
| Core functionality tests | ~25 |
| Regression tests | ~8 |
| Integration tests | ~8 |
| Edge case tests | ~8 |

### Test Implementation Priority

1. **IMMEDIATE**: OOG handling tests (marked TODO in code)
2. **IMMEDIATE**: Key authorization state consistency tests
3. **HIGH**: Gas parameter tests for T1
4. **HIGH**: Hardfork transition tests
5. **MEDIUM**: Initial gas TIP-1000 cost tests
6. **MEDIUM**: EIP-7702 no-refund tests
7. **LOWER**: EVM configuration tests
8. **LOWER**: Integration/E2E tests

---

## Implemented Tests

### AA Transaction Gas Tests (`crates/revm/src/evm.rs`)

Tests that execute AA transactions with T1 hardfork and verify exact gas usage.

| Test | Gas Used | Description |
|------|----------|-------------|
| `test_aa_tx_gas_baseline_identity_call` | **278,738** | Simple identity precompile call with new account (250k) + base costs |
| `test_aa_tx_gas_sstore_new_slot` | **530,863** | SSTORE to new slot (250k) + new account (250k) + base costs |
| `test_aa_tx_gas_sstore_warm_slot` | **283,663** | SSTORE to existing slot (no 250k SSTORE set cost) |
| `test_aa_tx_gas_multiple_sstores` | **783,069** | 2 SSTOREs to new slots (2Ã—250k) + new account (250k) |
| `test_aa_tx_gas_create_contract` | **778,720** | Contract creation: TX create (250k) + new account (250k) + base |
| `test_aa_tx_gas_single_vs_multiple_calls` | **278,738** / **284,102** | Single vs triple call comparison |
| `test_aa_tx_gas_sload_cold_vs_warm` | **280,866** | Cold SLOAD (2100) + warm SLOAD (100) + new account (250k) |

### EVM Configuration Tests (`crates/evm/src/evm.rs`)

| Test | Description |
|------|-------------|
| `test_tempo_evm_applies_gas_params` | Verifies `tempo_gas_params()` is applied to `cfg_env` |
| `test_tempo_evm_30m_gas_cap` | Verifies 30M gas limit cap is set |
| `test_tempo_evm_gas_params_differ_t0_vs_t1` | Verifies T0 vs T1 have different gas params (25k vs 12.5k for EIP-7702) |
| `test_tempo_evm_t1_state_creation_costs` | Verifies T1 state creation costs (SSTORE: 250k, CREATE: 500k, etc.) |

### TempoEvm Field Tests (`crates/revm/src/evm.rs`)

| Test | Description |
|------|-------------|
| `test_tempo_evm_with_inspector_preserves_fields` | Verifies `additional_initial_gas` and `initial_gas` preserved with inspector |
| `test_tempo_evm_take_logs` | Verifies `take_logs()` returns and clears logs |
