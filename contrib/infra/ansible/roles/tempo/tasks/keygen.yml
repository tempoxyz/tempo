---
- name: Remove existing validator files when force reset
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ ansible_env.HOME }}/malachite/config/priv_validator_key.json"
    - "{{ ansible_env.HOME }}/malachite/config/priv_key.pem"
    - "{{ ansible_env.HOME }}/malachite/config/pub_key.pem"
  when: tempo_force_reset

- name: Create malachite config directory
  file:
    path: "{{ ansible_env.HOME }}/malachite/config"
    state: directory
    mode: '0755'

- name: Generate ED25519 private key
  command: openssl genpkey -algorithm ED25519 -out "{{ ansible_env.HOME }}/malachite/config/priv_key.pem"
  args:
    creates: "{{ ansible_env.HOME }}/malachite/config/priv_key.pem"

- name: Extract raw private key hex
  shell: |
    openssl pkey -in "{{ ansible_env.HOME }}/malachite/config/priv_key.pem" -text -noout | \
    grep -A 3 "priv:" | tail -n 3 | tr -d ' \n:'
  register: priv_key_hex_output

- name: Extract public key
  command: openssl pkey -in "{{ ansible_env.HOME }}/malachite/config/priv_key.pem" -pubout -out "{{ ansible_env.HOME }}/malachite/config/pub_key.pem"
  args:
    creates: "{{ ansible_env.HOME }}/malachite/config/pub_key.pem"

- name: Extract raw public key hex
  shell: |
    openssl pkey -pubin -in "{{ ansible_env.HOME }}/malachite/config/pub_key.pem" -text -noout | \
    grep -A 3 "pub:" | tail -n 3 | tr -d ' \n:'
  register: pub_key_hex_output

- name: Set key variables
  set_fact:
    priv_key_hex: "{{ priv_key_hex_output.stdout }}"
    pub_key_hex: "{{ pub_key_hex_output.stdout }}"

- name: Generate address from public key
  shell: |
    echo "{{ pub_key_hex }}" | cut -c1-40
  register: address_output

- name: Generate base64 from public key
  shell: |
    echo "{{ pub_key_hex }}" | xxd -r -p | base64 -w 0
  register: pub_key_base64

- name: Generate base64 from private key
  shell: |
    echo "{{ priv_key_hex }}{{ pub_key_hex }}" | xxd -r -p | base64 -w 0
  register: priv_key_base64

- name: Set address variable
  set_fact:
    address: "{{ address_output.stdout }}"

- name: Generate priv_validator_key.json
  template:
    src: priv_validator_key.json.j2
    dest: "{{ ansible_env.HOME }}/malachite/config/priv_validator_key.json"
    mode: '0600'