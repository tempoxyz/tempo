---
- name: Add Caddy repository signing key to a dedicated keyring
  ansible.builtin.apt_key:
    url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
    state: present
    keyring: /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  become: yes

- name: Add Caddy APT repository (uses signed-by keyring)
  ansible.builtin.apt_repository:
    filename: caddy-stable
    repo: >-
      deb [signed-by=/usr/share/keyrings/caddy-stable-archive-keyring.gpg]
      https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main
    state: present
    update_cache: yes
  become: yes

- name: Install Caddy
  apt:
    name: caddy
    state: latest
    update_cache: yes
  become: yes

- name: Install JSON Parse plugin
  command:
    cmd: caddy add-package github.com/abiosoft/caddy-json-parse
  become: yes
  ignore_errors: true

- name: Create SSL certificate directory
  file:
    path: /etc/caddy/certs
    state: directory
    mode: '0700'
    owner: caddy
    group: caddy
  become: yes

- name: Install Cloudflare certificate
  copy:
    content: "{{ tempo_cloudflare_ca }}"
    dest: /etc/caddy/certs/cert.pem
    mode: '0600'
    owner: caddy
    group: caddy
  become: yes
  notify: restart caddy

- name: Install Cloudflare private key
  copy:
    content: "{{ tempo_cloudflare_private_key }}"
    dest: /etc/caddy/certs/key.pem
    mode: '0600'
    owner: caddy
    group: caddy
  become: yes
  notify: restart caddy

- name: Generate Caddyfile
  template:
    src: Caddyfile.j2
    dest: /etc/caddy/Caddyfile
    mode: '0644'
    owner: root
    group: root
  become: yes
  notify: restart caddy

- name: Enable and start Caddy service
  systemd:
    name: caddy
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes