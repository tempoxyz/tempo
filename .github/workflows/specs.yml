name: Specs

permissions: {}

on:
  push:
    branches: [main]
    paths:
      - "tips/ref-impls/**"
      - "crates/precompiles/**"
      - ".github/workflows/specs.yml"
  merge_group:
  pull_request:

env:
  FOUNDRY_PROFILE: ci
  CARGO_TERM_COLOR: always
  RUSTC_WRAPPER: "sccache"

jobs:
  check-specs-changes:
    name: Check specs changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      should_run: ${{ steps.filter.outputs.specs }}
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            specs:
              - 'tips/ref-impls/**'
              - 'crates/precompiles/**'
              - '.github/workflows/specs.yml'

  check-precompiles:
    name: Check precompiles changes
    needs: check-specs-changes
    if: needs.check-specs-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      coverage: ${{ steps.check.outputs.coverage }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Check for precompiles changes
        id: check
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
        run: |
          # Only run coverage on pull_request events when precompiles/contracts changed
          if [[ "$EVENT_NAME" != "pull_request" ]]; then
            echo "coverage=false" >> "$GITHUB_OUTPUT"
            echo "Skipping coverage: not a pull_request event (event: $EVENT_NAME)"
          elif git diff --name-only origin/"$BASE_REF"...HEAD | grep -qE '^(crates/(precompiles|contracts)/|tips/ref-impls/)'; then
            echo "coverage=true" >> "$GITHUB_OUTPUT"
            echo "Running coverage: precompiles/contracts changed"
          else
            echo "coverage=false" >> "$GITHUB_OUTPUT"
            echo "Skipping coverage: no precompiles/contracts changes"
          fi

  build:
    name: Forge Build
    needs: check-specs-changes
    if: needs.check-specs-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8789b3e21e6c11b2697f5eb56eddae542f746c10 # v1.7.0
        with:
          version: nightly

      - name: Run Forge build
        working-directory: tips/ref-impls
        run: forge build --sizes

  lint:
    name: Forge Fmt
    needs: check-specs-changes
    if: needs.check-specs-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8789b3e21e6c11b2697f5eb56eddae542f746c10 # v1.7.0
        with:
          version: nightly

      - name: Run Forge fmt check
        working-directory: tips/ref-impls
        run: forge fmt --check

  test:
    name: Forge Test (Solidity)
    needs: check-specs-changes
    if: needs.check-specs-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          submodules: recursive
          persist-credentials: false

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8789b3e21e6c11b2697f5eb56eddae542f746c10 # v1.7.0
        with:
          version: nightly

      - name: Run Forge tests
        working-directory: tips/ref-impls
        run: forge test -vvv --no-match-contract TempoTransactionInvariantTest

  tempo-foundry-test:
    name: Forge Test (Rust Precompiles)
    needs: [check-specs-changes, check-precompiles]
    # Skip for forked repos
    if: github.repository == 'tempoxyz/tempo' && needs.check-specs-changes.outputs.should_run == 'true'
    runs-on: depot-ubuntu-latest-8
    timeout-minutes: 60
    permissions:
      contents: read
    steps:
      - name: Checkout tempo
        uses: actions/checkout@v6
        with:
          submodules: recursive
          path: tempo
          persist-credentials: false

      - name: Checkout tempo-foundry
        uses: actions/checkout@v6
        with:
          repository: tempoxyz/tempo-foundry
          ref: tempo
          path: tempo-foundry
          persist-credentials: false

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1
      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
      - uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2.8.2
        with:
          workspaces: tempo-foundry

      - name: Install llvm-tools
        if: needs.check-precompiles.outputs.coverage == 'true'
        run: rustup component add llvm-tools-preview

      - name: Update tempo-foundry to use current commit
        working-directory: tempo-foundry
        run: |
          COMMIT_SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          echo "Updating tempo dependencies to commit: $COMMIT_SHA"

          # Update all tempo dependencies to point to the current commit
          # Using # as delimiter since URLs contain /
          sed -i -E \
            "s#(tempo-[a-z-]+) = \{ git = \"https://github.com/tempoxyz/tempo\", rev = \"[^\"]+\" \}#\1 = { git = \"https://github.com/tempoxyz/tempo\", rev = \"$COMMIT_SHA\" }#g" \
            Cargo.toml

          echo "Updated Cargo.toml:"
          grep "tempo-" Cargo.toml | head -20

          # Update Cargo.lock to resolve version conflicts
          cargo update

      # Build and run WITH coverage (only on PR when precompiles changed)
      - name: Build tempo-foundry forge with coverage instrumentation
        if: needs.check-precompiles.outputs.coverage == 'true'
        working-directory: tempo-foundry
        run: RUSTFLAGS="-C instrument-coverage" cargo build -p forge --profile release

      - name: Run Forge tests with Rust precompiles (with coverage)
        if: needs.check-precompiles.outputs.coverage == 'true'
        working-directory: tempo/tips/ref-impls
        run: |
          echo "Running forge test with tempo-foundry (isTempo=true)"
          LLVM_PROFILE_FILE="$(pwd)/forge-coverage-%p.profraw" ../../../tempo-foundry/target/release/forge test -vvv

      # Build and run WITHOUT coverage (main/merge_group or no precompiles changes)
      - name: Build tempo-foundry forge
        if: needs.check-precompiles.outputs.coverage != 'true'
        working-directory: tempo-foundry
        run: cargo build -p forge --profile release

      - name: Run Forge tests with Rust precompiles
        if: needs.check-precompiles.outputs.coverage != 'true'
        working-directory: tempo/tips/ref-impls
        run: |
          echo "Running forge test with tempo-foundry (isTempo=true)"
          ../../../tempo-foundry/target/release/forge test -vvv

      - name: Generate coverage profdata
        if: needs.check-precompiles.outputs.coverage == 'true'
        run: |
          LLVM_BIN="$(rustc --print sysroot)/lib/rustlib/$(rustc -vV | grep host | cut -d' ' -f2)/bin"
          mkdir -p coverage
          "$LLVM_BIN/llvm-profdata" merge -sparse tempo/tips/ref-impls/*.profraw -o coverage/forge-test.profdata

      - name: Upload forge coverage artifacts
        if: needs.check-precompiles.outputs.coverage == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: forge-test-coverage
          path: |
            coverage/forge-test.profdata
            tempo-foundry/target/release/forge
          retention-days: 1

  specs-success:
    name: specs success
    runs-on: ubuntu-latest
    if: always()
    permissions: {}
    needs:
      - check-specs-changes
      - check-precompiles
      - build
      - lint
      - test
      - tempo-foundry-test
    timeout-minutes: 5
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          allowed-failures: tempo-foundry-test
          allowed-skips: check-precompiles,build,lint,test,tempo-foundry-test
          jobs: ${{ toJSON(needs) }}

  precompiles-coverage:
    name: Precompiles Coverage
    needs: [check-precompiles, specs-success]
    if: success() && needs.check-precompiles.outputs.coverage == 'true'
    uses: ./.github/workflows/coverage.yml
    with:
      commit_sha: ${{ github.event.pull_request.head.sha || github.sha }}
      pr_number: ${{ github.event.pull_request.number || 0 }}
    permissions:
      contents: read
      pull-requests: write
      actions: read
