name: Docs Specs

on:
  push:
    branches: [main]
    paths:
      - "docs/specs/**"
      - "crates/precompiles/**"
      - ".github/workflows/docs-specs.yml"
  merge_group:
  pull_request:
    branches: [main]
    paths:
      - "docs/specs/**"
      - "crates/precompiles/**"
      - ".github/workflows/docs-specs.yml"

env:
  FOUNDRY_PROFILE: ci
  CARGO_TERM_COLOR: always
  RUSTC_WRAPPER: "sccache"

jobs:
  build:
    name: Forge Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8b0419c685ef46cb79ec93fbdc131174afceb730 # v1.6.0

      - name: Show Forge version
        run: forge --version

      - name: Run Forge build
        working-directory: docs/specs
        run: forge build --sizes

  lint:
    name: Forge Fmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8b0419c685ef46cb79ec93fbdc131174afceb730 # v1.6.0

      - name: Run Forge fmt check
        working-directory: docs/specs
        run: forge fmt --check

  test:
    name: Forge Test (Solidity)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8b0419c685ef46cb79ec93fbdc131174afceb730 # v1.6.0

      - name: Run Forge tests
        working-directory: docs/specs
        run: forge test -vvv

  tempo-foundry-test:
    name: Forge Test (Rust Precompiles)
    runs-on: depot-ubuntu-latest-8
    timeout-minutes: 60
    steps:
      - name: Checkout tempo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: recursive
          path: tempo

      - name: Checkout tempo-foundry
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: tempoxyz/tempo-foundry
          path: tempo-foundry

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1
      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9
      - uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: tempo-foundry

      - name: Update tempo-foundry to use current commit
        working-directory: tempo-foundry
        run: |
          COMMIT_SHA="${{ github.event.pull_request.head.sha || github.sha }}"
          echo "Updating tempo dependencies to commit: $COMMIT_SHA"

          # Update all tempo dependencies to point to the current commit
          # Using # as delimiter since URLs contain /
          sed -i -E \
            "s#(tempo-[a-z-]+) = \{ git = \"https://github.com/tempoxyz/tempo\", rev = \"[^\"]+\" \}#\1 = { git = \"https://github.com/tempoxyz/tempo\", rev = \"$COMMIT_SHA\" }#g" \
            Cargo.toml

          echo "Updated Cargo.toml:"
          grep "tempo-" Cargo.toml | head -20

          # Update Cargo.lock to resolve version conflicts
          cargo update

      - name: Build tempo-foundry forge
        working-directory: tempo-foundry
        run: cargo build -p forge --profile release

      - name: Run Forge tests with Rust precompiles
        working-directory: tempo/docs/specs
        run: |
          echo "Running forge test with tempo-foundry (isTempo=true)"
          ../../../tempo-foundry/target/release/forge test -vvv

  docs-specs-success:
    name: docs-specs success
    runs-on: ubuntu-latest
    if: always()
    needs:
      - build
      - lint
      - test
      - tempo-foundry-test
    timeout-minutes: 5
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe # v1.2.2
        with:
          allowed-failures: tempo-foundry-test
          jobs: ${{ toJSON(needs) }}
