---
id: TIP-1017
title: Subblocks v2 - Builder Delegation
description: Separates subblock builder identity from validator identity with many-to-one delegation, independent ed25519 signing, and expiring nonce support.
authors: Mallesh Pai
status: Draft
related: Subblock Specification, TIP-1009
protocolVersion: TBD
---

# TIP-1017: Subblocks v2 - Builder Delegation

## Abstract

This TIP introduces major changes to the subblock system:

1. **Builder Delegation**: Validators can delegate subblock production to a builder identified by an ed25519 public key. Multiple validators can delegate to the same builder, who accumulates their combined gas budget.

2. **Separate Signing Key**: Builders sign subblocks with their own ed25519 key, separate from the validator's consensus key. This avoids sharing the consensus key while keeping the same signature scheme.

3. **Nonce Key Format**: The nonce key format changes to `0x5b | builder_pubkey_prefix | nonce`, embedding the builder identity directly in the transaction.

4. **Expiring Nonces in Subblocks**: Subblock transactions can use expiring nonces by setting the nonce portion to all 1s (`0xFFFF...`).

## Motivation

The current subblock design has several limitations:

1. **Validator coupling**: The validator's consensus key must also sign subblocks, meaning validators cannot delegate subblock production to separate infrastructure without sharing their consensus key.

2. **One-to-one only**: Each validator must run their own subblock builder; there's no way to delegate to a shared builder.

3. **No expiring nonces**: Subblock transactions require sequential 2D nonces, preventing use of expiring nonces (TIP-1009).

This TIP addresses these issues by:

- Allowing validators to delegate to builders identified by ed25519 public key
- Supporting many-to-one delegation where multiple validators share a builder
- Using the builder's own ed25519 key for subblock signing (separate from consensus key)
- Builders join the authenticated commonware p2p network for subblock delivery
- Enabling expiring nonces within subblock transactions

---

# Specification

## 1. Subblock Registry

A new Subblock Registry precompile stores builder configurations and validator delegations.

### 1.1 Data Structures

```solidity
struct BuilderConfig {
    address feeRecipient;  // where subblock fees are sent
    address feeToken;      // preferred TIP-20 token for fee payment
}
```

**Note on fee token**: The builder's fee token is stored in `SubblockRegistry`, separate from `TipFeeManager.validatorTokens`. This allows:
- **Subblock fees** (for txs in builder's subblocks): `SubblockRegistry.configOf(builder).feeToken`
- **Proposer fees** (when validator is block proposer): `TipFeeManager.validatorTokens[validator]`

When processing fees for a subblock transaction:
1. Resolve the user's fee token using standard Tempo resolution (tx preference → user preference → inference → PathUSD)
2. Extract `builder_pubkey_prefix` from nonce key (bytes 11-30)
3. Resolve full builder pubkey from SubBlockMetadata, verify prefix matches
4. Look up `config = SubblockRegistry.configOf(builder)`
5. If registered and `config.feeToken` differs, attempt to swap via Fee AMM if liquidity available
6. If no liquidity or unregistered, fees are paid directly in the user's resolved fee token
7. Fees are sent to `config.feeRecipient`

### 1.2 Storage

```solidity
// Validator → builder they delegate to (zero = not delegated)
mapping(address => bytes32) public delegatedBuilder;

// Builder pubkey → their configuration
mapping(bytes32 => BuilderConfig) public builderConfig;

// Builder pubkey → number of validators delegating to them (gas weight)
mapping(bytes32 => uint256) public gasWeight;
```

### 1.3 Interface

```solidity
interface ISubblockRegistry {
    // ========== Validator Functions ==========

    /// @notice Delegates the caller's subblock production to a builder.
    /// @param builder The builder's ed25519 public key.
    /// @dev Only callable by validators in the ValidatorConfig set.
    /// @dev Clears any existing delegation first.
    /// @dev Increments the builder's gasWeight.
    /// @dev Requires builderConfig[builder].feeRecipient != address(0).
    function delegateToBuilder(bytes32 builder) external;

    /// @notice Clears the caller's delegation.
    /// @dev Only callable by validators with an existing delegation.
    /// @dev Decrements the previous builder's gasWeight.
    function clearDelegation() external;

    // ========== Builder Functions ==========

    /// @notice Sets a builder's configuration. Requires ed25519 signature proving ownership.
    /// @param builder The builder's ed25519 public key.
    /// @param feeRecipient Where subblock fees are sent.
    /// @param feeToken Preferred TIP-20 token for fee payment.
    /// @param signature ed25519 signature over keccak256(builder, feeRecipient, feeToken).
    /// @dev The precompile verifies the signature against the builder pubkey.
    function setBuilderConfig(bytes32 builder, address feeRecipient, address feeToken, bytes calldata signature) external;

    /// @notice Clears a builder's configuration.
    /// @param builder The builder's ed25519 public key.
    /// @param signature ed25519 signature proving ownership.
    function clearBuilderConfig(bytes32 builder, bytes calldata signature) external;

    // ========== View Functions ==========

    /// @notice Returns the builder a validator has delegated to.
    /// @param validator The validator address.
    /// @return The builder's ed25519 public key, or zero if not delegated.
    function builderOf(address validator) external view returns (bytes32);

    /// @notice Returns a builder's configuration.
    /// @param builder The builder's ed25519 public key.
    /// @return The BuilderConfig struct (zero values if not configured).
    function configOf(bytes32 builder) external view returns (BuilderConfig memory);

    /// @notice Returns a builder's fee recipient.
    /// @param builder The builder's ed25519 public key.
    /// @return The fee recipient, or zero if not configured.
    function feeRecipientFor(bytes32 builder) external view returns (address);

    /// @notice Returns a builder's preferred fee token.
    /// @param builder The builder's ed25519 public key.
    /// @return The TIP-20 token address, or zero if not configured.
    function feeTokenFor(bytes32 builder) external view returns (address);

    /// @notice Returns a builder's gas weight (number of delegating validators).
    /// @param builder The builder's ed25519 public key.
    /// @return The gas weight.
    function gasWeightOf(bytes32 builder) external view returns (uint256);
}
```

### 1.4 Behavior

**Delegation:**
- Only addresses in the `ValidatorConfig` validator set can call `delegateToBuilder()`
- The SubblockRegistry queries `ValidatorConfig.validators(msg.sender)` to verify the caller is a validator
- When delegating, any existing delegation is cleared first (atomically updates gasWeight)
- Changes take effect immediately in the next block

**Builder configuration:**
- `setBuilderConfig()` requires an ed25519 signature proving ownership of the builder key
- The precompile verifies the signature natively (no EVM ed25519 verification needed)
- `feeRecipient` MUST be set (non-zero) before validators can delegate to a builder
- If `feeToken` is zero, no swap is attempted (user's token is used)

**Gas weight:**
- `gasWeight[builder]` is the count of validators currently delegating to that builder
- Incremented when a validator calls `delegateToBuilder(builder)`
- Decremented when a validator calls `clearDelegation()` or delegates to a different builder
- Used to compute the builder's total gas budget

**Validator set changes:**
- The subblock builder is separate infrastructure from the validator node. A validator being temporarily "down" or offline does NOT affect their builder's ability to produce subblocks.
- `gasWeight[builder]` always reflects the number of validators **in the consensus set** delegating to that builder.
- When a validator is **removed from ValidatorConfig** (exits the validator set):
  - Their delegation MUST be cleared
  - `gasWeight` for their builder is decremented
  - This can be done lazily (during next delegation change) or eagerly (via callback from ValidatorConfig)
- This ensures gas budgets accurately reflect the current validator set.

### 1.5 Precompile Address

```
SUBBLOCK_REGISTRY_ADDRESS = 0x0b10c0000000000000000000000000000000000X  // TBD
```

### 1.6 Relationship to ValidatorConfig

The SubblockRegistry is a **separate precompile** from ValidatorConfig but **depends on it** for validator set membership:

```
┌─────────────────────┐         ┌─────────────────────┐
│   ValidatorConfig   │◄────────│   SubblockRegistry  │
│                     │  reads  │                     │
│  (validator set)    │         │ - delegatedBuilder  │
│                     │         │ - builderConfig     │
│                     │         │ - gasWeight         │
└─────────────────────┘         └─────────────────────┘
     Source of truth              Builder delegation
     for validator set            configuration
```

- ValidatorConfig defines **who is in the validator set** (used for consensus)
- SubblockRegistry tracks **builder delegations** (separate from consensus)

**P2P peer set**: Builders with `gasWeight > 0` are included in the epoch-authorized peer set alongside validators. The DKG Manager reads active builder pubkeys from SubblockRegistry and adds them to the commonware p2p oracle, allowing builders to join the authenticated network.

---

## 2. Nonce Key Format

### 2.1 Subblock Nonce Key

Subblock transactions use the following nonce key format:

```
32 bytes total:
┌──────────────────┬──────────────────────────────────┬─────────────────────┐
│ 0x5b (1 byte)    │ builder_pubkey_prefix (20 bytes)  │ nonce (11 bytes)    │
├──────────────────┼──────────────────────────────────┼─────────────────────┤
│ byte 31 (MSB)    │ bytes 11-30                      │ bytes 0-10          │
└──────────────────┴──────────────────────────────────┴─────────────────────┘
```

- **Byte 31 (MSB)**: `0x5b` prefix identifying this as a subblock transaction
- **Bytes 11-30**: First 20 bytes of the builder's ed25519 public key
- **Bytes 0-10**: 11-byte nonce value (2^88 possible values)

### 2.2 Nonce Key Construction

```
nonceKey = (0x5b << 248) | (builder_pubkey[0..20] << 88) | nonce
```

### 2.3 Builder Extraction

```
builder_pubkey_prefix = nonceKey[1..21]  // 20 bytes
```

The full builder pubkey is resolved from SubBlockMetadata and verified to start with this prefix.

### 2.4 Nonce Extraction

```solidity
function extractNonce(uint256 nonceKey) pure returns (uint88) {
    return uint88(nonceKey);
}
```

### 2.5 Subblock Transaction Detection

```solidity
function isSubblockTx(uint256 nonceKey) pure returns (bool) {
    return uint8(nonceKey >> 248) == 0x5b;
}
```

---

## 3. Expiring Nonces in Subblocks

### 3.1 Motivation

TIP-1009 introduced expiring nonces for parallel transaction submission without sequential ordering. This TIP extends that support to subblock transactions.

### 3.2 Detection

A subblock transaction uses expiring nonce semantics if:
1. The nonce key has `0x5b` prefix (bytes 31)
2. The nonce portion (bytes 0-10) is all 1s: `0xFFFFFFFFFFFFFFFFFFFFFF` (max uint88, 11 bytes)

```solidity
uint88 constant EXPIRING_NONCE_MARKER = type(uint88).max;  // 0xFFFFFFFFFFFFFFFFFFFFFF

function isSubblockExpiringNonce(uint256 nonceKey) pure returns (bool) {
    return isSubblockTx(nonceKey) && extractNonce(nonceKey) == EXPIRING_NONCE_MARKER;
}
```

### 3.3 Nonce Key Format (Expiring)

```
32 bytes total:
┌──────────────────┬──────────────────────────────────┬─────────────────────┐
│ 0x5b (1 byte)    │ builder_pubkey_prefix (20 bytes)  │ 0xFFF...FF (11 bytes)│
├──────────────────┼──────────────────────────────────┼─────────────────────┤
│ byte 31 (MSB)    │ bytes 11-30                      │ bytes 0-10 = max    │
└──────────────────┴──────────────────────────────────┴─────────────────────┘
```

### 3.4 Replay Protection

Subblock expiring nonce transactions follow TIP-1009 semantics:
- `validBefore` field is required
- `nonce` field must be `0`
- Replay protection via transaction hash + **same circular buffer** as TIP-1009
- Same validity window (30 seconds max)

The only difference from standard expiring nonces is the nonce key format, which routes the transaction to a specific builder. The replay protection shares the same `expiringNonceSeen` and `expiringNonceRing` storage as regular expiring nonces—no separate buffer is needed since the transaction hash is globally unique.

### 3.5 Nonce Key Construction (Expiring)

```
expiringNonceKey = (0x5b << 248) | (builder_pubkey[0..20] << 88) | EXPIRING_NONCE_MARKER
```

---

## 4. Signed Subblock Structure

### 4.1 SubBlock

```rust
struct SubBlock {
    version: SubBlockVersion,  // V2 for this spec
    parent_hash: B256,         // Block hash this subblock builds on
    builder: B256,             // Builder's ed25519 public key
    transactions: Vec<Transaction>,
}
```

### 4.2 SignedSubBlock

```rust
struct SignedSubBlock {
    subblock: SubBlock,
    signature: Bytes,  // ed25519 signature from builder's key
}
```

### 4.3 Signature Computation

```
signature_hash = keccak256(0x78 || RLP(subblock))
signature = ed25519_sign(builder_private_key, signature_hash)
```

### 4.4 Signature Verification

```
hash = keccak256(0x78 || RLP(subblock))
valid = ed25519_verify(subblock.builder, hash, signature)
```

### 4.5 Version

This TIP introduces `SubBlockVersion::V2`. Nodes MUST reject V1 subblocks after activation.

---

## 5. Subblock Metadata

### 5.1 SubBlockMetadata

The proposer includes metadata about included subblocks in a system transaction:

```rust
struct SubBlockMetadataEntry {
    builder: B256,           // Builder's ed25519 public key
    tx_start_index: u32,     // Index of first tx in block
    tx_count: u32,           // Number of transactions
    signature: Bytes,        // ed25519 signature
}

struct SubBlockMetadata {
    entries: Vec<SubBlockMetadataEntry>,
}
```

### 5.2 Metadata Validation

During block execution, the SubBlockMetadata system transaction is processed:

1. For each entry:
   a. Verify ed25519 signature against `entry.builder` pubkey
   b. Verify transactions in range have nonce key prefix matching `entry.builder[0..20]`
   c. Verify `gasWeight[builder] > 0` (at least one validator delegates to this builder)

2. Verify ranges are non-overlapping and within block bounds

### 5.3 Gas Budget Enforcement

Each builder's subblock is limited by their accumulated gas budget:

```
per_validator_gas = (block_gas_limit / TEMPO_SHARED_GAS_DIVISOR) / num_validators
builder_gas_budget = per_validator_gas × gasWeight[builder]
```

The metadata includes the `builder` pubkey. During validation:
1. Look up `gasWeight[builder]` from SubblockRegistry
2. Compute builder's gas budget as `per_validator_gas × gasWeight`
3. Verify subblock's total gas usage does not exceed budget

---

## 6. Fee Routing

### 6.1 Fee Recipient Resolution

For subblock transactions (nonce key has `0x5b` prefix):

1. Extract `builder_pubkey_prefix` from nonce key (bytes 11-30)
2. Resolve full builder pubkey from SubBlockMetadata, verify prefix matches
3. Look up `config = SubblockRegistry.configOf(builder)`
4. Use `config.feeRecipient` (required to be non-zero for active builders)

### 6.2 Fee Token Resolution

The user's fee token is resolved using standard Tempo resolution:
1. Transaction's explicit `fee_token` field (if set)
2. User's default fee token preference (from user config)
3. Inference from transaction context
4. PathUSD (default)

### 6.3 Fee Token Swap

If `user_fee_token != builder_fee_token` and the builder has a token preference:
- If sufficient AMM liquidity exists, swap to `builder_fee_token`
- If insufficient liquidity, the fee recipient receives `user_fee_token` directly

The transaction is **never invalidated** due to missing AMM liquidity.

### 6.4 Unregistered Builders

Builders must have `feeRecipient` configured before any validator can delegate to them. If a builder's config is cleared while delegations exist:
- `feeRecipientFor(builder)` returns zero
- `feeTokenFor(builder)` returns zero (no swap attempted)
- Fees are paid directly in the user's resolved fee token to the block proposer

---

## 7. Transaction Routing

### 7.1 Builder Endpoint

Builders MUST expose an RPC endpoint for receiving subblock transactions from users. Users submit transactions to the builder whose pubkey prefix matches their nonce key.

### 7.2 Subblock Delivery via P2P

Builders join the authenticated commonware p2p network using their ed25519 key. Builders send signed subblocks directly to the next proposer via p2p, the same mechanism used in V1.

The proposer stores received subblocks and selects them for inclusion during block building.

### 7.3 Builder P2P Authorization

Builders with `gasWeight > 0` are added to the epoch-authorized peer set. When a builder's `gasWeight` drops to zero (all validators undelegated), they are removed from the authorized set at the next epoch boundary.

---

## 8. End-to-End Flow

### 8.1 Setup (Once per Builder)

```
1. Builder generates an ed25519 keypair
2. Builder calls SubblockRegistry.setBuilderConfig(
       builderPubKey, feeRecipient, feeToken, signature
   )
3. Builder starts a commonware p2p node with their ed25519 key
```

### 8.2 Setup (Once per Validator)

```
1. Validator selects a builder to delegate to
2. Validator calls SubblockRegistry.delegateToBuilder(builder)
3. Registry increments builder's gasWeight
```

### 8.3 Transaction Creation (User)

```
1. User selects a builder by ed25519 public key
2. User constructs nonce key: 0x5b | builder_pubkey[0..20] | nonce
   - For sequential: nonce = next available value
   - For expiring: nonce = 0xFFF...FF (max uint88)
3. User signs transaction with ROOT EOA key (no keychain)
4. User submits transaction to builder's RPC endpoint
```

### 8.4 Subblock Building (Builder)

```
1. Builder collects transactions matching their pubkey prefix in nonce key
2. Builder validates each transaction (nonce, balance, execution)
3. Builder orders transactions, respects gas budget
4. Builder creates SubBlock with parent_hash = current chain tip
5. Builder signs with ed25519 → SignedSubBlock
6. Builder sends to next proposer via commonware p2p
```

### 8.5 Block Building (Proposer)

```
1. Proposer receives SignedSubBlocks from builders via p2p
2. For each subblock:
   a. Verify ed25519 signature against subblock.builder pubkey
   b. Verify all txs have nonce key prefix matching builder_pubkey[0..20]
   c. Verify parent_hash matches current tip
   d. Verify `gasWeight[builder] > 0`
   e. Compute builder's gas budget from gasWeight
   f. Verify total gas does not exceed budget
   g. Execute transactions, verify validity
3. Select valid subblocks
4. Build SubBlockMetadata with tx_start_index/tx_count for each
5. Append SubBlockMetadata system transaction at end of block
```

### 8.6 Block Execution (All Nodes)

```
1. Execute block transactions in order
2. For each 0x5b transaction:
   a. Extract builder_pubkey_prefix from nonce key (bytes 11-30)
   b. Determine if expiring nonce (nonce = max uint88)
   c. If expiring: use TIP-1009 replay protection
   d. Else: use 2D nonce semantics
   e. Look up fee recipient and token from registry
   f. Deduct fees, credit to fee recipient
3. Process SubBlockMetadata system transaction:
   a. Verify ed25519 signatures for each entry
   b. Verify tx ranges match actual transactions
   c. If any verification fails, block is invalid
```

---

## 9. Gas Accounting

### 9.1 Per-Validator Gas Budget

Gas budgets are computed per-validator:

```
shared_gas_limit = block_gas_limit / TEMPO_SHARED_GAS_DIVISOR
per_validator_gas = shared_gas_limit / num_validators
```

### 9.2 Builder Gas Budget

A builder's gas budget is the sum of per-validator gas for all validators in the consensus set delegating to them:

```
builder_gas_budget = per_validator_gas × gasWeight[builder]
```

Since delegations are cleaned up when validators leave the set (see Section 1.4), `gasWeight` accurately reflects the builder's current gas allocation.

### 9.3 Gas Incentive Lane

Unused gas from subblocks becomes available for the gas incentive lane:

```
incentive_gas = Σ (per_validator_gas - subblock_gas_used)
```

Transactions after subblocks may use this pooled unused gas.

---

## 10. Subblock Lifecycle

### 10.1 Subblock Validity

A signed subblock is valid only if:
- `parent_hash` matches the current chain tip
- The ed25519 signature verifies against `subblock.builder`
- `gasWeight[builder] > 0` (at least one validator in the set delegates to this builder)
- All transactions have nonce key prefix `0x5b` with `builder_pubkey[0..20]` matching
- Total gas does not exceed the builder's computed gas budget

**Fee failure**: If a subblock transaction cannot pay fees (e.g., user emptied their account in the main block), the transaction becomes a noop but the nonce is still incremented. The block remains valid.

### 10.2 Subblock Expiry

Subblocks expire immediately when `parent_hash` becomes stale. Subblocks have a 1-block lifetime.

### 10.3 Conflicting Subblocks

If a builder submits multiple subblocks for the same `parent_hash`, the proposer selects the one with higher total gas used (maximizing fees).

### 10.4 Deduplication

Validators deduplicate received subblocks by `(builder, parent_hash)`. Only the most recent (or highest-gas) subblock is retained.

---

# Invariants

## Must Hold

| ID | Invariant |
|----|-----------|
| **S1** | Delegation requirement: Only validators in the consensus set can call `delegateToBuilder()` |
| **S2** | Gas weight consistency: `gasWeight[builder]` equals count of validators in the set delegating to that builder |
| **S3** | Nonce key format: All 0x5b transactions have builder pubkey prefix in bytes 11-30 |
| **S4** | Signature validity: Subblock ed25519 signatures verify against the declared `builder` pubkey |
| **S5** | Builder match: All transactions in a subblock have nonce key prefix matching builder pubkey[0..20] |
| **S6** | Range validity: Metadata tx ranges are non-overlapping, ordered, and within bounds |
| **S7** | Fee routing: Fees are sent to `feeRecipientFor(builder)` |
| **S8** | Root-only signing: 0x5b transactions reject keychain signatures |
| **S9** | Gas budget: Each builder's subblock does not exceed their computed gas budget |
| **S10** | Immediate effect: Delegation and config changes take effect in the next block |
| **S11** | Expiring nonce detection: Nonce = max uint88 triggers TIP-1009 semantics |

## Test Cases

1. **Happy path**: Validator delegates to builder, user submits tx, builder creates subblock, proposer includes it
2. **Many-to-one delegation**: Multiple validators delegate to same builder, builder gets combined gas budget
3. **Signature verification**: Invalid ed25519 signature causes block rejection
4. **Builder mismatch**: Tx with wrong builder in nonce key rejected from subblock
5. **Overlapping ranges**: Block with overlapping metadata ranges is invalid
6. **Keychain signature**: 0x5b tx with keychain signature is rejected
7. **Unregistered builder**: Delegation rejected if builder has no feeRecipient configured
8. **Builder rotation**: Validator changes delegation, old builder loses gas weight
9. **Gas budget exceeded**: Subblock exceeding computed gas budget is rejected
10. **Conflicting subblocks**: Higher-gas subblock selected over lower-gas
11. **Stale parent hash**: Subblock with old parent_hash rejected
12. **Validator exits set**: Validator removed from ValidatorConfig, their delegation cleared, builder's gasWeight decremented
13. **Expiring nonce subblock**: Tx with nonce = max uint88 uses TIP-1009 replay protection
14. **Fee token swap with liquidity**: If AMM liquidity exists, builder receives their preferred token
15. **Fee token swap without liquidity**: If no AMM liquidity, fee recipient receives user's fee token

---

# Design Rationale

## Root-Only Signing for Subblock Transactions

Subblock transactions (0x5b prefix) require root EOA signatures and reject keychain (access key) signatures. This is intentional due to a race condition with key revocation:

1. User signs a 0x5b tx with an access key, submits to builder
2. Builder validates signature against current keychain state, includes in subblock
3. In the same block, a main block tx revokes that access key
4. Block execution order: main txs execute first, then subblock txs
5. When the subblock tx executes, the key is already revoked

The problem: signature validation happens at subblock validation time (before block building), not during execution. The subblock tx would still execute even though the key was revoked in the same block.

This violates user expectations. When a user revokes an access key, they expect immediate effect. Allowing keychain signatures for subblock txs would create a window where revoked keys can still authorize transactions.

**Alternative considered**: Re-validate keychain signatures during execution. This was rejected because:
- Adds execution-time overhead for every subblock tx
- Creates griefing vector: users could intentionally revoke keys to cause builder's subblock to fail
- Complicates the execution model

Root-only signing is the simplest solution that maintains user expectations around key revocation.

---

# Implementation Notes

## Relationship to Current Implementation

The current implementation stores subblock-related configuration as follows:

| Data | Current Location | TIP-1017 Location |
|------|------------------|-------------------|
| Fee recipient address | CLI arg (`--consensus.fee-recipient`) | `SubblockRegistry.builderConfig[builder].feeRecipient` |
| Subblock signing key | CLI arg (`--consensus.signing-key`), ed25519 | Builder's own ed25519 key (separate from consensus key) |
| Subblock fee token | `TipFeeManager.validatorTokens[validator]` | `SubblockRegistry.builderConfig[builder].feeToken` |
| Proposer fee token | `TipFeeManager.validatorTokens[validator]` | Unchanged (remains in `TipFeeManager`) |
| P2P identity | Validator ed25519 key | Builder's own ed25519 key (joins p2p network) |

Key changes:
1. **Separate signing key**: Builder has their own ed25519 key, not the validator's consensus key
2. **Many-to-one delegation**: Validators can share a builder, accumulating gas budgets
3. **Builder configures fee routing**: The builder (not validator) sets fee recipient and token preferences
4. **Builder joins p2p**: Builder is an authenticated peer on the commonware p2p network
5. **Expiring nonce support**: Subblock txs can use expiring nonces by setting nonce = max uint88

---

# Migration

## Activation

This TIP activates at a specific block height. After activation:

- SubBlockVersion::V1 subblocks are rejected
- The old nonce key format (`0x5b | validator_pubkey_prefix | nonce`) is no longer valid
- Validators must delegate to a builder before their subblock gas is usable

## Migration Steps

1. **Pre-activation**: Builders call `setBuilderConfig()` to configure their fee routing
2. **Pre-activation**: Validators call `delegateToBuilder()` to delegate their gas budget
3. **Activation block**: Protocol switches to V2 subblock validation
4. **Post-activation**: V1 subblocks and old nonce key formats are rejected

Validators who want to build their own subblocks should generate a new ed25519 key and delegate to it:
```solidity
// Builder key is separate from consensus key
SubblockRegistry.setBuilderConfig(builderPubKey, msg.sender, preferredFeeToken, signature);
SubblockRegistry.delegateToBuilder(builderPubKey);
```
