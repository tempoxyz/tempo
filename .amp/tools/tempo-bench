#!/usr/bin/env bash
# Amp toolbox tool: Run a full Tempo benchmark

if [ "$TOOLBOX_ACTION" = "describe" ]; then
    cat <<'EOF'
name: tempo-bench
description: Run a full Tempo benchmark with observability stack, nodes, and tempo-bench. Use this instead of manually running nu tempo.nu bench.
preset: string Transaction type preset: tip20, erc20, swap, order, or tempo-mix (required unless bench_args provided)
mode: string Mode: dev or consensus (default: consensus)
tps: number Target transactions per second (default: 10000)
duration: number Duration in seconds (default: 30)
accounts: number Number of accounts (default: 1000)
nodes: number Number of consensus nodes (default: 3, consensus mode only)
genesis: string Custom genesis file path (skips generation)
reset: boolean Reset localnet before starting (default: false)
loud: boolean Show all node logs (default: false, only WARN/ERROR shown)
samply: boolean Profile nodes with samply (default: false)
samply_args: string Additional samply arguments (space-separated)
profile: string Cargo build profile (default: profiling)
features: string Cargo features (default: jemalloc,asm-keccak)
node_args: string Additional node arguments (space-separated)
bench_args: string Additional tempo-bench arguments (space-separated)
EOF
    exit 0
fi

if [ "$TOOLBOX_ACTION" = "execute" ]; then
    input=$(cat)
    
    preset=$(echo "$input" | grep -E '^preset:' | sed 's/^preset: *//')
    mode=$(echo "$input" | grep -E '^mode:' | sed 's/^mode: *//')
    tps=$(echo "$input" | grep -E '^tps:' | sed 's/^tps: *//')
    duration=$(echo "$input" | grep -E '^duration:' | sed 's/^duration: *//')
    accounts=$(echo "$input" | grep -E '^accounts:' | sed 's/^accounts: *//')
    nodes=$(echo "$input" | grep -E '^nodes:' | sed 's/^nodes: *//')
    genesis=$(echo "$input" | grep -E '^genesis:' | sed 's/^genesis: *//')
    reset=$(echo "$input" | grep -E '^reset:' | sed 's/^reset: *//')
    loud=$(echo "$input" | grep -E '^loud:' | sed 's/^loud: *//')
    samply=$(echo "$input" | grep -E '^samply:' | sed 's/^samply: *//')
    samply_args=$(echo "$input" | grep -E '^samply_args:' | sed 's/^samply_args: *//')
    profile=$(echo "$input" | grep -E '^profile:' | sed 's/^profile: *//')
    features=$(echo "$input" | grep -E '^features:' | sed 's/^features: *//')
    node_args=$(echo "$input" | grep -E '^node_args:' | sed 's/^node_args: *//')
    bench_args=$(echo "$input" | grep -E '^bench_args:' | sed 's/^bench_args: *//')
    
    cmd="nu tempo.nu bench"
    
    [ -n "$preset" ] && cmd="$cmd --preset $preset"
    [ -n "$mode" ] && cmd="$cmd --mode $mode"
    [ -n "$tps" ] && cmd="$cmd --tps $tps"
    [ -n "$duration" ] && cmd="$cmd --duration $duration"
    [ -n "$accounts" ] && cmd="$cmd --accounts $accounts"
    [ -n "$nodes" ] && cmd="$cmd --nodes $nodes"
    [ -n "$genesis" ] && cmd="$cmd --genesis $genesis"
    [ "$reset" = "true" ] && cmd="$cmd --reset"
    [ "$loud" = "true" ] && cmd="$cmd --loud"
    [ "$samply" = "true" ] && cmd="$cmd --samply"
    [ -n "$samply_args" ] && cmd="$cmd --samply-args=\"$samply_args\""
    [ -n "$profile" ] && cmd="$cmd --profile $profile"
    [ -n "$features" ] && cmd="$cmd --features $features"
    [ -n "$node_args" ] && cmd="$cmd --node-args=\"$node_args\""
    [ -n "$bench_args" ] && cmd="$cmd --bench-args=\"$bench_args\""
    
    echo "Running: $cmd"
    eval "$cmd"
fi
