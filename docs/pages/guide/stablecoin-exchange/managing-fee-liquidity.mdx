import { Callout } from 'vocs/components'

# Managing Fee Liquidity

When a user pays fees in a different stablecoin than the validator's preference, the Fee AMM performs an automatic conversion. For example:

- User pays 0.01 USDC for fees
- Validator wants USDT
- Fee AMM swaps 0.01 USDC â†’ 0.009970 USDT (0.3% fee to liquidity providers)
- Validator receives 0.009970 USDT

This conversion requires the pool to have sufficient USDT reserves. Without liquidity, users cannot pay fees in tokens that differ from the validator's preference.
## When to Add Liquidity

### New Token Pairs

When a new stablecoin launches or a validator begins accepting a new token, the corresponding Fee AMM pools need initial liquidity. Without liquidity, users cannot pay fees in the new token.

For initial liquidity provision, you can provide the entire amount in the validator token. The pool will naturally accumulate user tokens as fees are paid.

### Low Reserve Pools

Pools with insufficient reserves will reject transactions that require conversion. Monitor pool reserves and add liquidity when:

- Transaction rejection rates increase
- Reserve levels drop below expected daily volume
- Multiple validators begin preferring the same token

### High Volume Periods

During periods of high transaction volume, pools may need additional liquidity to handle the increased conversion demand.

## When to Remove Liquidity

### Low Utilization

If a pool sees little activity (few fee conversions), liquidity providers may want to redeploy capital elsewhere.

### Pool Imbalance

After extended periods where users pay in one token but validators prefer another, pools can become heavily imbalanced. Liquidity providers may want to withdraw and let arbitrageurs rebalance the pool first.

<Callout type="warning">
  Withdrawals are blocked if they would prevent pending fee swaps from executing. You must wait until after block settlement to retry.
</Callout>

## Rebalancing

Fee swaps drain the validator token from pools and accumulate the user token. For example:

- Pool starts with 100,000 USDT, 0 USDC
- Users pay 10,000 USDC in fees
- Pool now has ~90,000 USDT, 10,000 USDC

Arbitrageurs can rebalance the pool by swapping in the opposite direction at a fixed rate of 0.9985:

- Arbitrageur deposits ~9,985 USDT
- Receives 10,000 USDC back
- Profits 15 USDC (minus gas costs)

This rebalancing:
- Restores the pool's validator token reserves
- Enables continued fee conversions
- Is only profitable when the two tokens have similar market prices

Rebalancing can be done by anyone and is typically performed by arbitrage bots monitoring pool ratios.

## Earning Rewards

Liquidity providers earn fees from two sources:

### Fee Swaps (0.3%)

Every fee conversion generates a 0.3% fee for liquidity providers:
- User pays 1.0 of their token
- Validator receives 0.9970 of their token
- 0.003 stays in the pool as LP rewards

### Rebalancing Swaps (0.15%)

Rebalancing swaps also generate fees:
- Arbitrageur pays 0.9985 of validator token
- Receives 1.0 of user token
- 0.0015 effective fee stays in the pool

Fees automatically accumulate in the pool reserves, increasing the value of your LP tokens over time.

## How to Provide Liquidity

Liquidity provision involves:

1. **Approving tokens** - Allow the AMM contract to spend your tokens
2. **Minting LP tokens** - Deposit validator token to receive LP tokens representing your share
3. **Burning LP tokens** - Return LP tokens to withdraw your share plus accumulated fees

### First Liquidity Provider

The first liquidity provider to a new pool must burn 1,000 units of liquidity (similar to Uniswap v2). This has a cost of approximately $0.002 and helps prevent certain attacks on the pool's reserves.

The first provider deposits only `validatorToken` and receives half that many units (rounded down) of liquidity, minus the 1,000 units that are burned.

### Subsequent Liquidity Providers

Subsequent liquidity providers also deposit only `validatorToken`. The amount of liquidity they receive depends on the pool state:
- If the pool has only `validatorToken`, they receive a pro rata share based on their contribution
- If the pool has both tokens, the liquidity calculation accounts for an equivalent rebalancing swap before applying the pro rata share

For implementation details and code examples, see:
- [`amm.mint()`](/sdk/typescript/viem/amm.mint) - Add liquidity
- [`amm.getPool()`](/sdk/typescript/viem/amm.getPool) - Check pool reserves
- [`amm.getLiquidityBalance()`](/sdk/typescript/viem/amm.getLiquidityBalance) - Check your LP tokens

For complete technical specifications, see the [Fee AMM Protocol Specification](/documentation/protocol/fees/spec-fee-amm).
