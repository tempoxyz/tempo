import * as Demo from '../../../components/guides/Demo.tsx'
import * as Step from '../../../components/guides/steps'
import * as Card from '../../../components/Card.tsx'
import LucideFileText from '~icons/lucide/file-text'
import LucideBookOpen from '~icons/lucide/book-open'

# Distribute Rewards

Distribute rewards to token holders using TIP-20's built-in reward distribution mechanism. Rewards allow parties to incentivize holders of a token by streaming tokens proportionally based on their balance.

Rewards can be started by anyone on any TIP-20 token, and claimed by any holder who has opted in. This guide focuses on the issuer use case: starting and claiming rewards on a token you created, but the same principles apply to any token.

## Demo

Try out the complete rewards flow: opt in to receive rewards, create a reward for yourself, use your token to accumulate the reward, and claim it.

<Demo.Container name="Distribute Rewards" footerVariant="source" src="tempoxyz/tempo-ts/tree/main/examples/issuance">
  <Step.Connect stepNumber={1} />
  <Step.AddFunds stepNumber={2} />
  <Step.CreateOrLoadToken stepNumber={3} />
  <Step.GrantTokenRoles stepNumber={4} roles={['issuer']} />
  <Step.MintToken stepNumber={5} />
  <Step.OptInToRewards stepNumber={6} />
  <Step.StartReward stepNumber={7} />
  <Step.SendPaymentWithIssuedToken stepNumber={8} amount='1' flowDependencies={['rewardId']} />
  <Step.ClaimReward stepNumber={9} last />
</Demo.Container>

## Steps

::::steps

### Create a Stablecoin

Before you can distribute rewards, you need a token. Follow the [Create a Stablecoin](/guide/issuance/create-a-stablecoin) guide to deploy your token, or load an existing one.

### Opt In to Rewards

Token holders must opt in to receive rewards by setting their reward recipient address. This is typically set to their own address.

:::code-group

```tsx twoslash [OptInToRewards.tsx]
import React from 'react'
import { Hooks } from 'tempo.ts/wagmi'
import { useAccount } from 'wagmi'

// @noErrors
export function OptInToRewards() {
  const { address } = useAccount()
  const tokenAddress = '0x...' // Your token address

  const setRecipient = Hooks.reward.useSetRecipientSync()

  const handleOptIn = () => { // [!code hl]
    if (!address) return // [!code hl]
    setRecipient.mutate({ // [!code hl]
      recipient: address, // [!code hl]
      token: tokenAddress, // [!code hl]
      feeToken: '0x20c0000000000000000000000000000000000001', // [!code hl]
    }) // [!code hl]
  } // [!code hl]

  return (
    <button 
      disabled={setRecipient.isPending}
      onClick={handleOptIn}
      type="button"
    >
      {setRecipient.isPending ? 'Opting in...' : 'Opt In to Rewards'}
    </button>
  )
}
```

```tsx twoslash [config.ts] filename="config.ts"
// @noErrors
import { createConfig, http } from 'wagmi'
import { tempo } from 'tempo.ts/chains'
import { KeyManager, webAuthn } from 'tempo.ts/wagmi'

export const config = createConfig({
  chains: [tempo({ feeToken: '0x20c0000000000000000000000000000000000001' })],
  connectors: [webAuthn({
    keyManager: KeyManager.localStorage(),
  })],
  transports: {
    [tempo.id]: http(),
  },
})
```

:::

### Use Your Token

After opting in, any interaction with the token (transfers, receiving payments, etc.) will accumulate rewards.

In the demo above, we send a small transfer to trigger reward accumulation.

### View and Claim Rewards

Once you have accumulated rewards, you can view your reward info and claim the reward to receive the tokens.

:::code-group

```tsx twoslash [ClaimReward.tsx]
import React from 'react'
import { Hooks } from 'tempo.ts/wagmi'
import { useAccount } from 'wagmi'

// @noErrors
export function ClaimReward() {
  const { address } = useAccount()
  const tokenAddress = '0x...' // Your token address

  const { data: rewardInfo } = Hooks.reward.useUserRewardInfo({
    token: tokenAddress,
    account: address,
  })

  const claim = Hooks.reward.useClaimSync()

  const handleClaim = () => { // [!code hl]
    claim.mutate({ // [!code hl]
      token: tokenAddress, // [!code hl]
      feeToken: '0x20c0000000000000000000000000000000000001', // [!code hl]
    }) // [!code hl]
  } // [!code hl]

  const hasClaimableRewards = rewardInfo?.rewardBalance // [!code hl]
    && rewardInfo.rewardBalance > 0n // [!code hl]

  return (
    <button
      disabled={claim.isPending || !hasClaimableRewards}
      onClick={handleClaim}
      type="button"
    >
      {claim.isPending ? 'Claiming...' : 'Claim Rewards'}
    </button>
  )
}
```

```tsx twoslash [config.ts] filename="config.ts"
// @noErrors
import { createConfig, http } from 'wagmi'
import { tempo } from 'tempo.ts/chains'
import { KeyManager, webAuthn } from 'tempo.ts/wagmi'

export const config = createConfig({
  chains: [tempo({ feeToken: '0x20c0000000000000000000000000000000000001' })],
  connectors: [webAuthn({
    keyManager: KeyManager.localStorage(),
  })],
  transports: {
    [tempo.id]: http(),
  },
})
```

:::

::::

## Recipes

### Start a reward distribution

As a token issuer, you can start a reward distribution that allocates tokens to all opted-in holders proportionally based on their balance.

:::code-group

```tsx twoslash [StartReward.tsx]
import React from 'react'
import { Hooks } from 'tempo.ts/wagmi'
import { parseUnits } from 'viem'

// @noErrors
export function StartReward() {
  const tokenAddress = '0x...' // Your token address

  const { data: metadata } = Hooks.token.useGetMetadata({
    token: tokenAddress,
  })

  const start = Hooks.reward.useStartSync()

  const handleStart = () => { // [!code hl]
    if (!metadata) return // [!code hl]
    start.mutate({ // [!code hl]
      amount: parseUnits('50', metadata.decimals), // [!code hl]
      token: tokenAddress, // [!code hl]
      feeToken: '0x20c0000000000000000000000000000000000001', // [!code hl]
    }) // [!code hl]
  } // [!code hl]

  return (
    <button
      disabled={start.isPending || !metadata}
      onClick={handleStart}
      type="button"
    >
      {start.isPending ? 'Starting...' : 'Start Reward'}
    </button>
  )
}
```

```tsx twoslash [config.ts] filename="config.ts"
// @noErrors
import { createConfig, http } from 'wagmi'
import { tempo } from 'tempo.ts/chains'
import { KeyManager, webAuthn } from 'tempo.ts/wagmi'

export const config = createConfig({
  chains: [tempo({ feeToken: '0x20c0000000000000000000000000000000000001' })],
  connectors: [webAuthn({
    keyManager: KeyManager.localStorage(),
  })],
  transports: {
    [tempo.id]: http(),
  },
})
```

:::

### Start rewards stream ðŸš§

Coming soon. Stream rewards over time using the `seconds` parameter to gradually distribute tokens to holders. See the [spec](/documentation/protocol/tip20-rewards/spec#tip-20-rewards-functions) for more information.


## Learning Resources

<Card.Container>
  <Card.Link
    description="See the TIP-20 rewards spec"
    href="/documentation/protocol/tip20-rewards/spec"
    icon={LucideFileText}
    title="TIP-20 Rewards Spec"
  />
  <Card.Link
    description="Read an overview of TIP-20 rewards"
    href="/documentation/protocol/tip20-rewards/overview"
    icon={LucideBookOpen}
    title="TIP-20 Rewards Overview"
  />
</Card.Container>
