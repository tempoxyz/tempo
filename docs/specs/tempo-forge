#!/usr/bin/env bash
#
# Run forge commands using tempo-foundry's custom forge binary.
# This tests the Solidity specs against the actual Rust precompile implementations.
#
# Usage:
#   ./tempo-forge [forge-args...]
#
# Examples:
#   ./tempo-forge test                         # Run all tests
#   ./tempo-forge test -vvv                    # Run with verbose output
#   ./tempo-forge test --match-test test_mint  # Run specific test
#   ./tempo-forge build                        # Build contracts
#
# Prerequisites:
#   - Rust toolchain installed
#   - tempo-foundry repo cloned as a sibling to tempo repo:
#       Tempo/
#         tempo/          <- this repo
#         tempo-foundry/  <- tempo-foundry repo
#
# The script will:
#   1. Locate or build the tempo-foundry forge binary
#   2. Run forge with the Rust precompiles enabled (isTempo=true)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Try to find tempo-foundry in common locations
TEMPO_FOUNDRY_PATHS=(
    "$TEMPO_ROOT/../tempo-foundry"           # Sibling directory
    "$TEMPO_ROOT/../../tempo-foundry"        # Parent's sibling
    "${TEMPO_FOUNDRY_PATH:-}"                # Environment variable override
)

TEMPO_FOUNDRY_DIR=""
for path in "${TEMPO_FOUNDRY_PATHS[@]}"; do
    if [[ -n "$path" && -d "$path" && -f "$path/Cargo.toml" ]]; then
        TEMPO_FOUNDRY_DIR="$path"
        break
    fi
done

if [[ -z "$TEMPO_FOUNDRY_DIR" ]]; then
    echo "Error: Could not find tempo-foundry repository."
    echo ""
    echo "Please either:"
    echo "  1. Clone tempo-foundry as a sibling to the tempo repo:"
    echo "     git clone git@github.com:tempoxyz/tempo-foundry.git ../tempo-foundry"
    echo ""
    echo "  2. Set TEMPO_FOUNDRY_PATH environment variable:"
    echo "     export TEMPO_FOUNDRY_PATH=/path/to/tempo-foundry"
    exit 1
fi

FORGE_BIN="$TEMPO_FOUNDRY_DIR/target/debug/forge"

echo "Using tempo-foundry at: $TEMPO_FOUNDRY_DIR"

# Check if forge binary exists, build if not
if [[ ! -x "$FORGE_BIN" ]]; then
    echo "Building tempo-foundry forge binary..."
    echo "(This may take a few minutes on first run)"
    echo ""
    (cd "$TEMPO_FOUNDRY_DIR" && cargo build -p forge --profile dev)
fi

if [[ ! -x "$FORGE_BIN" ]]; then
    echo "Error: Failed to build forge binary at $FORGE_BIN"
    exit 1
fi

echo "Using forge binary: $FORGE_BIN"
echo ""

# Run forge from the specs directory
cd "$SCRIPT_DIR"
exec "$FORGE_BIN" "$@"
