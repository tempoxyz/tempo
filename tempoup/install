#!/usr/bin/env bash
set -e

# Tempoup bootstrap installer
# Downloads tempoup script and installs to /usr/local/bin

BIN_DIR="${TEMPO_BIN_DIR:-/usr/local/bin}"
TEMPOUP_URL="https://raw.githubusercontent.com/tempoxyz/tempo/main/tempoup/tempoup"

# Color output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() {
    echo -e "${GREEN}info${NC}: $1"
}

warn() {
    echo -e "${YELLOW}warn${NC}: $1"
}

# Install a file to BIN_DIR, using sudo if necessary
install_bin() {
    local src="$1"
    local dst="$2"

    if cp "$src" "$dst" 2>/dev/null; then
        chmod +x "$dst"
    elif sudo cp "$src" "$dst" 2>/dev/null; then
        sudo chmod +x "$dst"
    else
        echo "error: failed to install to $dst"
        echo "       try running with sudo"
        exit 1
    fi
}

main() {
    echo "Installing tempoup..."
    echo ""

    # Download tempoup script to a temp file
    local tmp_file
    tmp_file="$(mktemp 2>/dev/null || mktemp -t tempoup)"
    trap "rm -f '$tmp_file'" EXIT

    info "Downloading tempoup script..."
    if command -v curl >/dev/null 2>&1; then
        curl -# -L "$TEMPOUP_URL" -o "$tmp_file"
    elif command -v wget >/dev/null 2>&1; then
        wget --show-progress -q -O "$tmp_file" "$TEMPOUP_URL"
    else
        echo "error: neither curl nor wget found"
        exit 1
    fi

    # Install tempoup to BIN_DIR
    install_bin "$tmp_file" "$BIN_DIR/tempoup"
    info "Tempoup installed to $BIN_DIR/tempoup"

    # Warn if BIN_DIR is not in PATH
    if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
        echo ""
        warn "$BIN_DIR is not in your PATH"
        echo "  Add it to your shell config:"
        echo "    export PATH=\"$BIN_DIR:\$PATH\""
        echo ""
    fi

    # Run tempoup to install tempo binary
    info "Running tempoup to install tempo..."
    echo ""

    TEMPO_BIN_DIR="$BIN_DIR" "$BIN_DIR/tempoup"
}

main
